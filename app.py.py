import streamlit as st
import pandas as pd
import io

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="Excel to CSV Converter", page_icon="üìÇ")

st.title("üìÇ ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏õ‡πá‡∏ô CSV")
st.write("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á/‡∏Ç‡∏µ‡∏î) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ")

# ==========================================
# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Config)
# ==========================================
target_columns = [
    '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏á', 
    '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', 
    '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
    '‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏',       
    '‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
    '‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á',
    '‡πÅ‡∏ú‡πà‡∏ô‡∏õ‡πâ‡∏≤‡∏¢',
    '‡∏õ‡πâ‡∏≤‡∏¢‡∏ß‡∏á‡∏Å‡∏•‡∏°',
    '‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠',
    '‡∏™‡∏≤‡∏Ç‡∏≤'
]
# ==========================================

# 1. ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
uploaded_file = st.file_uploader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)", type=['xlsx'])

if uploaded_file is not None:
    try:
        # ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
        df = pd.read_excel(uploaded_file)
        
        # ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
        original_rows = len(df)

        # ==========================================
        # üßπ ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î)
        # ==========================================
        if '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' in df.columns:
            # 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (String) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            df['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'] = df['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'].astype(str)
            
            # 2. ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á (Trim whitespace) ‡πÄ‡∏ä‡πà‡∏ô "  1‡∏Å‡∏Ç  " -> "1‡∏Å‡∏Ç"
            df['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'] = df['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'].str.strip()
            
            # 3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô 'nan', ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á '', ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏µ‡∏î '-' ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Null ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
            invalid_values = ['nan', 'NaN', '', '-', 'None']
            df = df[~df['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'].isin(invalid_values)]
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å
            filtered_rows = len(df)
            removed_rows = original_rows - filtered_rows
            
            st.success(f"‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {original_rows} ‡πÅ‡∏ñ‡∏ß)")
            
            if removed_rows > 0:
                st.info(f"üßπ ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ **{removed_rows}** ‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ **{filtered_rows}** ‡πÅ‡∏ñ‡∏ß)")
            else:
                st.info("üëç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô")
        else:
            st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ")

        # ==========================================
        # üïí ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
        # ==========================================
        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' in df.columns:
            df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'] = pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'], errors='coerce')
            df['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'] = df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'] + pd.DateOffset(years=1)
            df['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'] = df['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'].dt.date
        
        # 2. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (Column Selector)
        all_columns = df.columns.tolist()
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
        default_selection = [col for col in target_columns if col in all_columns]
        
        st.subheader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:")
        
        # [NEW] ‡πÄ‡∏û‡∏¥‡πà‡∏° Checkbox ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        select_all = st.checkbox("‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Select All)")
        
        # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ all_columns ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ default_selection
        if select_all:
            final_selection = all_columns
        else:
            final_selection = default_selection

        # ‡πÅ‡∏™‡∏î‡∏á Multiselect
        # key=f"select_{select_all}" ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏¥‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏î‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        selected_columns = st.multiselect(
            "‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå:",
            options=all_columns,
            default=final_selection,
            key=f"select_{select_all}" 
        )

        if selected_columns:
            # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            df_selected = df[selected_columns]
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            st.write("### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:")
            st.dataframe(df_selected.head(10))
            
            # 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            csv_buffer = df_selected.to_csv(index=False).encode('utf-8-sig')
            
            st.download_button(
                label="‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV",
                data=csv_buffer,
                file_name="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô.csv",
                mime="text/csv",
            )
        else:
            st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏£‡∏±‡∏ö")
            
    except Exception as e:
        st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")

